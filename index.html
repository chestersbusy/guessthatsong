<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web API Example</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #2d3748; /* Slightly lighter dark background for container */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 900px; /* Increased max-width */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            cursor: pointer; /* Ensure cursor pointer for all buttons */
            text-align: center;
            display: inline-flex; /* Use flex for icon + text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .btn-spotify {
            background-color: #1DB954; /* Spotify green */
            color: white;
            box-shadow: 0 4px 6px rgba(29, 185, 84, 0.3);
        }
        .btn-spotify:hover:not(:disabled) {
            background-color: #1ed760;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(29, 185, 84, 0.4);
        }
        .btn-spotify:disabled {
            background-color: #0f6e30; /* Darker green when disabled */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-secondary {
            background-color: #4a5568; /* Gray */
            color: white;
            box-shadow: 0 4px 6px rgba(74, 85, 104, 0.3);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #616f84;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(74, 85, 104, 0.4);
        }
        .btn-icon {
            background: none;
            border: none;
            color: #cbd5e0;
            padding: 0.5rem;
            font-size: 1.5rem;
            transition: color 0.2s ease-in-out;
        }
        .btn-icon:hover:not(:disabled) {
            color: #1DB954; /* Spotify green on hover */
        }
        .btn-icon.active {
            color: #1DB954; /* Active state for shuffle */
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #cbd5e0;
            margin-bottom: 1rem;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 0.5rem;
        }
        .data-display {
            background-color: #1a202c;
            padding: 1.5rem;
            border-radius: 0.75rem;
            min-height: 100px;
            overflow-x: auto; /* Allow horizontal scrolling for long data */
            white-space: pre-wrap; /* Preserve whitespace and wrap long lines */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .playlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Responsive grid */
            gap: 1rem;
        }
        .playlist-card {
            background-color: #1a202c;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
            cursor: pointer; /* Indicate it's clickable */
        }
        .playlist-card:hover {
            transform: translateY(-5px);
            background-color: #2d3748; /* Slightly lighter on hover */
        }
        .playlist-card img {
            width: 120px;
            height: 120px;
            border-radius: 0.5rem;
            object-fit: cover;
            margin-bottom: 0.75rem;
        }
        .playlist-card h3 {
            font-size: 1rem;
            font-weight: bold;
            color: #cbd5e0;
            margin-bottom: 0.25rem;
        }
        .playlist-card p {
            font-size: 0.8rem;
            color: #a0aec0;
        }
        .message-box {
            background-color: #4299e1; /* Blue for info messages */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none; /* Hidden by default */
        }
        .message-box.error {
            background-color: #e53e3e; /* Red for error messages */
        }
        .message-box.show {
            display: block;
        }
        /* Styles for Playlist Detail Page */
        .playlist-detail-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center; /* Center items on small screens */
            text-align: center; /* Center text on small screens */
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .playlist-detail-header {
                justify-content: flex-start; /* Align to start on larger screens */
                text-align: left; /* Align text to left on larger screens */
            }
        }
        .playlist-detail-header img {
            width: 180px;
            height: 180px;
            border-radius: 0.75rem;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .playlist-info {
            flex-grow: 1;
        }
        .playlist-info h2 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #1DB954; /* Spotify green */
            margin-bottom: 0.5rem;
        }
        .playlist-info p {
            font-size: 1rem;
            color: #cbd5e0;
            margin-bottom: 0.25rem;
        }
        .track-list {
            list-style: none;
            padding: 0;
        }
        .track-item {
            background-color: #1a202c;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .track-item:last-child {
            margin-bottom: 0;
        }
        .track-info {
            flex-grow: 1;
        }
        .track-info h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .track-info p {
            font-size: 0.85rem;
            color: #a0aec0;
        }
        .track-duration {
            font-size: 0.85rem;
            color: #a0aec0;
            margin-left: 1rem;
            flex-shrink: 0; /* Prevent duration from wrapping */
        }

        /* Now Playing Section Styles */
        #nowPlayingSection {
            background-color: #1a202c;
            padding: 1rem;
            border-radius: 0.75rem;
            /* Removed margin-top as it's now inside a flex container */
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Adjusted shadow for top placement */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            flex-grow: 1; /* Allow it to grow within the flex header */
            min-width: 250px; /* Ensure it has a minimum width */
        }
        #nowPlayingAlbumArt {
            width: 60px;
            height: 60px;
            border-radius: 0.25rem;
            object-fit: cover;
            flex-shrink: 0;
        }
        .now-playing-info {
            flex-grow: 1;
            min-width: 150px; /* Ensure info has space */
        }
        .now-playing-info h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .now-playing-info p {
            font-size: 0.8rem;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .now-playing-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
        }
        .now-playing-controls .btn-icon {
            font-size: 1.8rem; /* Larger icons for controls */
        }
        .now-playing-controls .play-pause-btn {
            font-size: 2.5rem; /* Even larger for play/pause */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-8 flex justify-center items-start min-h-screen">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-green-400 mb-6">Guess That Song</h1>

        <!-- Message Box -->
        <div id="messageBox" class="message-box"></div>

        <!-- Authentication Section -->
        <div id="authSection" class="text-center">
            <p class="text-lg mb-4">Log in with your Spotify account to access your data.</p>
            <button id="loginButton" class="btn btn-spotify">Log in to Spotify</button>
        </div>

        <!-- Main Application Section (Playlists) -->
        <div id="appSection" class="hidden">
            <p class="text-lg mb-4 text-center">Select a playlist below to begin playing</p>

            <h2 class="section-title">Your Playlists</h2>
            <div id="playlistsData" class="data-display">
                <p class="text-gray-400">Loading playlists...</p>
            </div>
            <div id="playlistsGrid" class="playlist-grid mt-4">
                <!-- Playlists will be rendered here -->
            </div>
        </div>

        <!-- Playlist Detail Section -->
        <div id="playlistDetailSection" class="hidden">
            <button id="backToPlaylistsButton" class="btn btn-secondary mb-6">‚Üê Back to Playlists</button>
            <div class="playlist-detail-header">
                <img id="detailPlaylistImage" src="https://placehold.co/180x180/333333/FFFFFF?text=No+Image" alt="Playlist Cover" class="rounded-lg shadow-lg">
                <div class="playlist-info">
                    <h2 id="detailPlaylistName" class="text-green-400 text-4xl font-bold mb-2"></h2>
                    <p id="detailPlaylistOwner" class="text-gray-300 text-lg mb-1"></p>
                    <p id="detailPlaylistDescription" class="text-gray-400 text-sm mb-2"></p>
                    <p id="detailPlaylistTracksCount" class="text-gray-400 text-sm"></p>
                    <button id="playPlaylistButton" class="btn btn-spotify mt-4"><i class="fas fa-play"></i> Play Playlist</button>
                </div>
                <div id="nowPlayingSection" class="hidden">
                    <img id="nowPlayingAlbumArt" src="https://placehold.co/60x60/333333/FFFFFF?text=No+Art" alt="Album Art">
                    <div class="now-playing-info">
                        <h4 id="nowPlayingSongTitle">Not playing</h4>
                        <p id="nowPlayingArtists"></p>
                    </div>
                    <div class="now-playing-controls">
                        <button id="shuffleButton" class="btn-icon"><i class="fas fa-random"></i></button>
                        <button id="skipPreviousButton" class="btn-icon"><i class="fas fa-backward"></i></button>
                        <button id="playPauseButton" class="btn-icon play-pause-btn"><i class="fas fa-play"></i></button>
                        <button id="skipNextButton" class="btn-icon"><i class="fas fa-forward"></i></button>
                        <button id="hideInfoButton" class="btn-icon"><i class = "fa-solid fa-eye-slash"></i></button>
                    </div>
                </div>
            </div>
            <h3 class="section-title">Tracks</h3>
            <div id="detailPlaylistTracksLoading" class="text-gray-400 text-center py-4">Loading tracks...</div>
            <ul id="detailPlaylistTracks" class="track-list">
                <!-- Tracks will be rendered here -->
            </ul>
        </div>
    </div>

    <script>
        // Spotify API Configuration
        const clientId = 'a06feae73e1e44a39ade90ab01408397';
        // IMPORTANT: Replace 'YOUR_LOCAL_IP_ADDRESS' with your computer's actual local IP (e.g., 192.168.1.100)
        // This MUST match the Redirect URI configured in your Spotify Developer Dashboard exactly!
        const redirectUri = 'http://127.0.0.1:8080/spotify_app.html';
        const scopes = [
            'user-read-private',
            'user-read-email',
            'playlist-read-private',
            'playlist-read-collaborative',
            'user-top-read',
            'user-modify-playback-state',
            'user-read-playback-state',
            'user-read-currently-playing'
        ];

        // Declare variables globally, but assign them inside DOMContentLoaded
        let loginButton, authSection, appSection, playlistsData, playlistsGrid, messageBox;
        let playlistDetailSection, backToPlaylistsButton, detailPlaylistImage, detailPlaylistName,
            detailPlaylistOwner, detailPlaylistDescription, detailPlaylistTracksCount,
            detailPlaylistTracks, detailPlaylistTracksLoading, playPlaylistButton;
        let nowPlayingSection, nowPlayingAlbumArt, nowPlayingSongTitle, nowPlayingArtists,
            playPauseButton, skipPreviousButton, skipNextButton, shuffleButton, hideInfoButton;

        let accessToken = null;
        let currentPage = 'auth';
        let playbackPollingInterval = null;
        let isPlaying = false;
        let isHidden = false;
        let isShuffleActive = false;
        // Explicitly declare on window object for robust global access
        window.tokenExpirationTimeoutId = null; 

        let songQueue = [];

        /**
         * Generates a random string for PKCE code verifier.
         * @param {number} length - The desired length of the string.
         * @returns {string} The random string.
         */
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        /**
         * Hashes a string using SHA256 and base64url encodes it.
         * @param {string} plain - The string to hash.
         * @returns {Promise<string>} A promise that resolves with the base64url encoded hash.
         */
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const base64 = btoa(String.fromCharCode.apply(null, hashArray));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, false otherwise.
         */
        function showMessage(message, isError = false) {
            // Ensure messageBox is not null before using it
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = 'message-box show';
                if (isError) {
                    messageBox.classList.add('error');
                } else {
                    messageBox.classList.remove('error');
                }
                // Hide message after 5 seconds
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 5000);
            } else {
                console.error("MessageBox element not found. Cannot display message:", message);
            }
        }

        /**
         * Initiates the Spotify OAuth Authorization Code Flow with PKCE.
         */
        async function redirectToSpotifyAuth() {
            if (!loginButton) {
                console.error("Login button not found. Cannot initiate Spotify auth.");
                showMessage("Login button not found. Please refresh the page.", true);
                return;
            }
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redirecting...';

            try {
                const verifier = generateRandomString(128);
                const challenge = await sha256(verifier);

                localStorage.setItem('spotify_code_verifier', verifier);

                const authUrl = new URL('https://accounts.spotify.com/authorize');
                authUrl.searchParams.append('client_id', clientId);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('redirect_uri', redirectUri);
                authUrl.searchParams.append('scope', scopes.join(' '));
                authUrl.searchParams.append('code_challenge_method', 'S256');
                authUrl.searchParams.append('code_challenge', challenge);

                window.location.href = authUrl.toString();
            } catch (error) {
                showMessage(`Error initiating Spotify login: ${error.message}`, true);
                console.error('Login Initiation Error:', error);
                loginButton.disabled = false;
                loginButton.innerHTML = 'Log in to Spotify';
            }
        }

        /**
         * Clears the access token and related data from localStorage and memory.
         */
        function clearAccessToken() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_expires_at');
            accessToken = null;
            if (window.tokenExpirationTimeoutId) { // Use window.tokenExpirationTimeoutId
                clearTimeout(window.tokenExpirationTimeoutId);
                window.tokenExpirationTimeoutId = null;
            }
            console.log("Access token and expiration cleared.");
        }

        /**
         * Sets up the token expiration timeout.
         * @param {number} expiresInMs - The time in milliseconds until the token expires.
         */
        function setupTokenExpiration(expiresInMs) {
            if (window.tokenExpirationTimeoutId) { // Use window.tokenExpirationTimeoutId
                clearTimeout(window.tokenExpirationTimeoutId); // Clear any existing timeout
            }
            window.tokenExpirationTimeoutId = setTimeout(() => { // Use window.tokenExpirationTimeoutId
                clearAccessToken();
                showMessage('Spotify access token expired. Please log in again.', true);
                currentPage = 'auth';
                renderPage();
                stopPlaybackPolling();
            }, expiresInMs);
            console.log(`Token expiration timeout set for ${expiresInMs / 1000} seconds.`);
        }

        /**
         * Handles the redirect from Spotify after authorization.
         * Exchanges the authorization code for an access token using PKCE.
         */
        async function handleSpotifyCallback() {
            console.log("handleSpotifyCallback called.");
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                console.log("Spotify authorization error:", error);
                showMessage(`Spotify authorization error: ${error}`, true);
                window.history.pushState("", document.title, window.location.pathname);
                currentPage = 'auth';
                renderPage();
                return;
            }

            if (code) {
                console.log("Authorization code received:", code);
                const verifier = localStorage.getItem('spotify_code_verifier');
                if (!verifier) {
                    console.error("PKCE code verifier not found.");
                    showMessage('PKCE code verifier not found. Please try logging in again.', true);
                    currentPage = 'auth';
                    renderPage();
                    return;
                }
                localStorage.removeItem('spotify_code_verifier');
                console.log("Code verifier found and removed from local storage.");

                try {
                    console.log("Attempting to exchange code for token...");
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: redirectUri,
                            code_verifier: verifier,
                        }).toString()
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Token exchange failed:", response.status, errorData);
                        throw new Error(`Token exchange error: ${response.status} - ${errorData.error_description || response.statusText}`);
                    }

                    const data = await response.json();
                    accessToken = data.access_token;
                    const expiresIn = data.expires_in; // in seconds

                    // Calculate absolute expiration time
                    const expiresAt = Date.now() + expiresIn * 1000; // in milliseconds

                    localStorage.setItem('spotify_access_token', accessToken);
                    localStorage.setItem('spotify_expires_at', expiresAt); // Store expiration timestamp
                    
                    setupTokenExpiration(expiresIn * 1000); // Set up the timeout

                    showMessage('Successfully logged in to Spotify!');
                    window.history.pushState("", document.title, window.location.pathname);
                    currentPage = 'app';
                    renderPage();
                    startPlaybackPolling();
                    getPlaylists(); // Automatically fetch playlists after login
                } catch (error) {
                    showMessage(`Error exchanging code for token: ${error.message}`, true);
                    console.error('Token Exchange Error:', error);
                    currentPage = 'auth';
                    renderPage();
                }
            } else {
                console.log("No authorization code received.");
                showMessage('Spotify authorization did not return a code. Please try again.', true);
                currentPage = 'auth';
                renderPage();
            }
        }

        /**
         * Makes an authenticated request to the Spotify Web API.
         * @param {string} endpoint - The API endpoint (e.g., '/me', '/me/playlists').
         * @param {string} reqMethod - HTTP method (GET, POST, PUT).
         * @param {Object} reqBody - Request body for POST/PUT.
         * @returns {Promise<Object>} - A promise that resolves with the JSON response.
         */
        async function callSpotifyApi(endpoint, reqMethod = 'GET', reqBody = null) {
            if (!accessToken) {
                console.error("callSpotifyApi: accessToken is null. Redirecting to auth.");
                showMessage('Not logged in to Spotify. Please log in first.', true);
                currentPage = 'auth';
                renderPage();
                return null;
            }

            const options = {
                method: reqMethod,
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            };

            if (reqBody) {
                options.body = JSON.stringify(reqBody);
            }
            console.log(`Calling Spotify API: ${endpoint} with method ${reqMethod}`);
            try {
                const response = await fetch(`https://api.spotify.com/v1${endpoint}`, options);

                if (response.status === 401) {
                    console.error("API call received 401 Unauthorized. Token likely expired.");
                    clearAccessToken(); // Clear the token immediately
                    showMessage('Access token expired or invalid. Please log in again.', true);
                    currentPage = 'auth';
                    renderPage();
                    stopPlaybackPolling();
                    return null;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error(`Spotify API error response for ${endpoint}:`, response.status, errorData);
                    throw new Error(`Spotify API error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                if (response.status === 204) {
                    console.log(`API call to ${endpoint} returned 204 No Content.`);
                    return {};
                }
                const data = await response.json();
                console.log(`API call to ${endpoint} successful. Data:`, data);
                return data;
            } catch (error) {
                showMessage(`Error calling Spotify API: ${error.message}`, true);
                console.error('Spotify API Call Error:', error);
                return null;
            }
        }

        /**
         * Fetches and displays the user's Spotify playlists.
         */
        async function getPlaylists() {
            console.log("getPlaylists called.");
            if (!playlistsData || !playlistsGrid) {
                console.error("playlistsData or playlistsGrid element not found in getPlaylists function. Cannot render playlists.");
                return;
            }
            
            playlistsData.innerHTML = '<p class="text-gray-400">Loading playlists...</p>';
            playlistsGrid.innerHTML = '';

            const playlists = await callSpotifyApi('/me/playlists'); // Default method is GET
            console.log("Playlists API response:", playlists);
            if (playlists && playlists.items) {
                playlistsData.innerHTML = '';
                showMessage('Playlists fetched successfully!');
                renderPlaylists(playlists.items);
            } else {
                playlistsData.innerHTML = '<p class="text-gray-400">Failed to load playlists or no playlists found.</p>';
            }
        }

        /**
         * Renders playlists as cards in a grid.
         * @param {Array} items - Array of playlist objects.
         */
        function renderPlaylists(items) {
            console.log("renderPlaylists called with items:", items);
            if (items.length === 0) {
                playlistsGrid.innerHTML = '<p class="text-gray-400">No playlists found.</p>';
                return;
            }

            items.forEach(playlist => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.dataset.playlistId = playlist.id;

                const imageUrl = playlist.images.length > 0 ? playlist.images[0].url : 'https://placehold.co/120x120/333333/FFFFFF?text=No+Image';
                const image = document.createElement('img');
                image.src = imageUrl;
                image.alt = playlist.name;
                image.onerror = function() {
                    this.onerror=null;
                    this.src='https://placehold.co/120x120/333333/FFFFFF?text=No+Image';
                };

                const name = document.createElement('h3');
                name.textContent = playlist.name;

                const owner = document.createElement('p');
                owner.textContent = `By ${playlist.owner.display_name}`;

                const tracks = document.createElement('p');
                tracks.textContent = `${playlist.tracks.total} tracks`;

                card.appendChild(image);
                card.appendChild(name);
                card.appendChild(owner);
                card.appendChild(tracks);
                
                card.addEventListener('click', () => showPlaylistDetails(playlist.id, playlist.uri));

                playlistsGrid.appendChild(card);
            });
            console.log("Playlists rendered to grid.");
        }

        /**
         * Fetches and displays details for a specific playlist.
         * @param {string} playlistId - The ID of the playlist to display/.
         * @param {string} playlistUri - The URI of the playlist for playback.
         */
        async function showPlaylistDetails(playlistId, playlistUri) {
            console.log("showPlaylistDetails called for playlistId:", playlistId);
            currentPage = 'playlistDetail';
            renderPage();

            if (playPlaylistButton) {
                playPlaylistButton.dataset.playlistUri = playlistUri;
            }

            detailPlaylistImage.src = 'https://placehold.co/180x180/333333/FFFFFF?text=Loading...';
            detailPlaylistName.textContent = 'Loading...';
            detailPlaylistOwner.textContent = '';
            detailPlaylistDescription.textContent = '';
            detailPlaylistTracksCount.textContent = '';
            detailPlaylistTracks.innerHTML = '';
            detailPlaylistTracksLoading.classList.remove('hidden');

            const playlist = await callSpotifyApi(`/playlists/${playlistId}`); // Default method is GET

            if(playlist) {
                detailPlaylistTracksLoading.classList.add('hidden');
                showMessage(`Playlist "${playlist.name}" details fetched successfully!`);

                const imageUrl = playlist.images.length > 0 ? playlist.images[0].url : 'https://placehold.co/180x180/333333/FFFFFF?text=No+Image';
                detailPlaylistImage.src = imageUrl;
                detailPlaylistImage.alt = playlist.name;
                detailPlaylistImage.onerror = function() {
                    this.onerror=null;
                    this.src='https://placehold.co/180x180/333333/FFFFFF?text=No+Image';
                };

                detailPlaylistName.textContent = playlist.name;
                detailPlaylistOwner.textContent = `By ${playlist.owner.display_name}`;
                detailPlaylistDescription.textContent = playlist.description || 'No description available.';
                detailPlaylistTracksCount.textContent = `${playlist.tracks.total} tracks`;

                if(playlist.tracks && playlist.tracks.items.length > 0) {
                    playlist.tracks.items.forEach(item => {
                        const track = item.track;
                        if(!track) return;

                        const listItem = document.createElement('li');
                        listItem.className = 'track-item';

                        const trackInfoDiv = document.createElement('div');
                        trackInfoDiv.className = 'track-info';

                        const trackName = document.createElement('h4');
                        trackName.textContent = track.name;

                        const artists = document.createElement('p');
                        artists.textContent = track.artists.map(artist => artist.name).join(', ');

                        trackInfoDiv.appendChild(trackName);
                        trackInfoDiv.appendChild(artists);

                        const duration = document.createElement('span');
                        duration.className = 'track-duration';
                        const minutes = Math.floor(track.duration_ms / 60000);
                        const seconds = ((track.duration_ms % 60000) / 1000).toFixed(0);
                        duration.textContent = `${minutes}:${(seconds < 10 ? '0' : '')}${seconds}`;

                        listItem.appendChild(trackInfoDiv);
                        listItem.appendChild(duration);
                        detailPlaylistTracks.appendChild(listItem);
                        songQueue.push(track.uri);
                    });
                } else {
                    const noTracksMessage = document.createElement('li');
                    noTracksMessage.className = 'text-gray-400 text-center py-4';
                    noTracksMessage.textContent = 'No tracks found in this playlist.';
                    detailPlaylistTracks.appendChild(noTracksMessage);
                }
            } else {
                detailPlaylistTracksLoading.classList.add('hidden');
                detailPlaylistName.textContent = 'Failed to load playlist details.';
            }
        }

        /**
         * Navigates back to main playlist view.
         */
        function goBackToPlaylists() {
            console.log("goBackToPlaylists called.");
            currentPage = 'app';
            songQueue = [];
            renderPage();
        }

        /**
         * Updates the play/pause button icon based on playback state.
         */
        function updatePlayPauseButton() {
            if (playPauseButton) {
                if (isPlaying) {
                    playPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
                }
            }
        }

        /**
         * Updates the shuffle button's active state.
         */
        function updateShuffleButton() {
            if (shuffleButton) {
                if (isShuffleActive) {
                    shuffleButton.classList.add('active');
                } else {
                    shuffleButton.classList.remove('active');
                }
            }
        }

        /**
         * Fetches and updates the current playback state and "Now Playing" display.
         */
        async function getPlaybackState() {
            console.log("getPlaybackState called.");
            const playbackState = await callSpotifyApi('/me/player');

            if (playbackState && playbackState.is_playing !== undefined) {
                isPlaying = playbackState.is_playing;
                isShuffleActive = playbackState.shuffle_state;
                updatePlayPauseButton();
                updateShuffleButton();

                if (playbackState.item && !isHidden) {
                    const item = playbackState.item;
                    const albumArtUrl = item.album.images.length > 0 ? item.album.images[0].url : 'https://placehold.co/60x60/333333/FFFFFF?text=No+Art';
                    nowPlayingAlbumArt.src = albumArtUrl;
                    nowPlayingAlbumArt.alt = item.name;
                    nowPlayingSongTitle.textContent = item.name;
                    nowPlayingArtists.textContent = item.artists.map(artist => artist.name).join(', ');
                } else {
                    nowPlayingAlbumArt.src = 'https://placehold.co/60x60/333333/FFFFFF?text=No+Art';
                    nowPlayingAlbumArt.alt = 'No song playing';
                    nowPlayingSongTitle.textContent = 'Not playing';
                    nowPlayingArtists.textContent = '';
                }
            } else {
                isPlaying = false;
                isShuffleActive = false;
                updatePlayPauseButton();
                updateShuffleButton();
                nowPlayingAlbumArt.src = 'https://placehold.co/60x60/333333/FFFFFF?text=No+Art';
                nowPlayingAlbumArt.alt = 'No song playing';
                nowPlayingSongTitle.textContent = 'Not playing';
                nowPlayingArtists.textContent = '';
            }
        }

        /**
         * Starts or pauses playback.
         */
        async function togglePlayPause() {
            console.log("togglePlayPause called. Current isPlaying:", isPlaying);
            if (isPlaying) {
                await callSpotifyApi('/me/player/pause', 'PUT');
                showMessage('Playback paused.');
            } else {
                await callSpotifyApi('/me/player/play', 'PUT');
                showMessage('Playback resumed.');
            }
            setTimeout(getPlaybackState, 500);
        }

        /**
         * Skips to the next track.
         */
        async function skipToNextTrack() {
            console.log("skipToNextTrack called.");
            if(isShuffleActive)
            {
                let index = Math.floor(Math.random() * (songQueue.length));
                let songID = songQueue[index];
                await callSpotifyApi('/me/player/play', 'PUT',{
                    uris: [songID]
                });
                songQueue.splice(index, 1);
            }
            else
            {
                await callSpotifyApi('/me/player/play', 'PUT',
                {
                    uris: [songQueue.shift()]
                });
            }
            showMessage('Skipped to next track.');
            showHideInfo(1);
            setTimeout(getPlaybackState, 500);
        }

        /**
         * Skips to the previous track.
         */
        async function skipToPreviousTrack() {
            console.log("skipToPreviousTrack called.");
            await callSpotifyApi('/me/player/previous', 'POST');
            showMessage('Skipped to previous track.');
            showHideInfo(1);
            setTimeout(getPlaybackState, 500);
        }

        /**
         * Toggles shuffle mode.
         */
        async function toggleShuffle() {
            console.log("toggleShuffle called. Current isShuffleActive:", isShuffleActive);
            const newShuffleState = !isShuffleActive;
            await callSpotifyApi(`/me/player/shuffle?state=${newShuffleState}`, 'PUT');
            isShuffleActive = newShuffleState;
            updateShuffleButton();
            showMessage(`Shuffle ${newShuffleState ? 'enabled' : 'disabled'}.`);
            setTimeout(getPlaybackState, 500);
        }

        /**
         * Starts playing a specific playlist.
         * @param {string} playlistUri - The Spotify URI of the playlist (e.g., 'spotify:playlist:37i9dQZF1DXcBWIGoYBM5M').
         */
        async function playPlaylistContext(playlistUri) {
            console.log("playPlaylistContext called with URI:", playlistUri);
            if (!playlistUri) {
                showMessage('No playlist URI provided to play.', true);
                return;
            }
            await callSpotifyApi('/me/player/play', 'PUT', {
                context_uri: playlistUri
            });
            showMessage('Playing playlist!');
            setTimeout(getPlaybackState, 500);
        }

        /**
         * Starts polling the Spotify API for playback state updates.
         */
        function startPlaybackPolling() {
            console.log("startPlaybackPolling called.");
            if (playbackPollingInterval) {
                clearInterval(playbackPollingInterval);
            }
            playbackPollingInterval = setInterval(getPlaybackState, 3000);
            getPlaybackState();
        }

        /**
         * Stops polling the Spotify API for playback state updates.
         */
        function stopPlaybackPolling() {
            console.log("stopPlaybackPolling called.");
            if (playbackPollingInterval) {
                clearInterval(playbackPollingInterval);
                playbackPollingInterval = null;
                nowPlayingAlbumArt.src = 'https://placehold.co/60x60/333333/FFFFFF?text=No+Art';
                nowPlayingAlbumArt.alt = 'No song playing';
                nowPlayingSongTitle.textContent = 'Not playing';
                nowPlayingArtists.textContent = '';
                isPlaying = false;
                isShuffleActive = false;
                updatePlayPauseButton();
                updateShuffleButton();
            }
        }

        /**
         * Manages the visibility of different sections based on the current page state.
         */
        function renderPage() {
            console.log("renderPage called. Current page:", currentPage);
            // Ensure all section elements are available before trying to manipulate their classes
            if (!authSection || !appSection || !playlistDetailSection || !nowPlayingSection) {
                console.error("One or more main section elements not found during renderPage. UI rendering may fail.");
                return;
            }

            // Hide all main sections first
            authSection.classList.add('hidden');
            appSection.classList.add('hidden');
            playlistDetailSection.classList.add('hidden');
            // nowPlayingSection.classList.add('hidden'); // Its visibility is now controlled by its parent

            // Then show the appropriate section
            if (currentPage === 'auth') {
                authSection.classList.remove('hidden');
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.innerHTML = 'Log in to Spotify';
                }
                stopPlaybackPolling();
            } else if (currentPage === 'app') {
                appSection.classList.remove('hidden');
                // nowPlayingSection.classList.remove('hidden'); // Removed as it's now inside playlistDetailSection
            } else if (currentPage === 'playlistDetail') {
                playlistDetailSection.classList.remove('hidden');
                // nowPlayingSection.classList.remove('hidden'); // Removed as it's now inside playlistDetailSection
            }
            console.log("renderPage completed. Visibility updated.");
        }

        /**
         * Shows or hides the now playing info
         */
        function showHideInfo(hide = 0)
        {
            console.log("show info called. hide = " + hide.toString());
            if(hide === 0)
            {
                if (hideInfoButton) {
                    if (isHidden) {
                        hideInfoButton.innerHTML = '<i class="fa-solid fa-eye"></i>';
                        getPlaybackState();
                        isHidden = false;
                    } else {
                        hideInfoButton.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                        
                        nowPlayingAlbumArt.src = 'https://placehold.co/60x60/333333/FFFFFF?text=No+Art';
                        nowPlayingAlbumArt.alt = 'No song playing';
                        nowPlayingSongTitle.textContent = 'Not playing';
                        nowPlayingArtists.textContent = '';
                        
                        isHidden = true;
                    }
                }
            }
            else
            {
                hideInfoButton.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                        
                nowPlayingAlbumArt.src = 'https://placehold.co/60x60/333333/FFFFFF?text=No+Art';
                nowPlayingAlbumArt.alt = 'No song playing';
                nowPlayingSongTitle.textContent = 'Not playing';
                nowPlayingArtists.textContent = '';
                
                isHidden = true;
            }
            
        }

        // Initialize the app and attach event listeners after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");
            // Assign ALL DOM elements here, ensuring they exist before any other code tries to use them
            loginButton = document.getElementById('loginButton');
            authSection = document.getElementById('authSection');
            appSection = document.getElementById('appSection');
            playlistsData = document.getElementById('playlistsData');
            playlistsGrid = document.getElementById('playlistsGrid');
            messageBox = document.getElementById('messageBox');

            playlistDetailSection = document.getElementById('playlistDetailSection');
            backToPlaylistsButton = document.getElementById('backToPlaylistsButton');
            detailPlaylistImage = document.getElementById('detailPlaylistImage');
            detailPlaylistName = document.getElementById('detailPlaylistName');
            detailPlaylistOwner = document.getElementById('detailPlaylistOwner');
            detailPlaylistDescription = document.getElementById('detailPlaylistDescription');
            detailPlaylistTracksCount = document.getElementById('detailPlaylistTracksCount');
            detailPlaylistTracks = document.getElementById('detailPlaylistTracks');
            detailPlaylistTracksLoading = document.getElementById('detailPlaylistTracksLoading');
            playPlaylistButton = document.getElementById('playPlaylistButton');

            nowPlayingSection = document.getElementById('nowPlayingSection');
            nowPlayingAlbumArt = document.getElementById('nowPlayingAlbumArt');
            nowPlayingSongTitle = document.getElementById('nowPlayingSongTitle');
            nowPlayingArtists = document.getElementById('nowPlayingArtists');
            playPauseButton = document.getElementById('playPauseButton');
            skipPreviousButton = document.getElementById('skipPreviousButton');
            skipNextButton = document.getElementById('skipNextButton');
            shuffleButton = document.getElementById('shuffleButton');
            hideInfoButton = document.getElementById('hideInfoButton');

            console.log("DOM elements assigned.");

            // Now that all elements are assigned, attach event listeners
            if (loginButton) {
                loginButton.addEventListener('click', redirectToSpotifyAuth);
                console.log("Login button event listener attached.");
            }
            if (backToPlaylistsButton) {
                backToPlaylistsButton.addEventListener('click', goBackToPlaylists);
                console.log("Back to Playlists button event listener attached.");
            }
            
            if (playPlaylistButton) {
                playPlaylistButton.addEventListener('click', () => {
                    const playlistUri = playPlaylistButton.dataset.playlistUri;
                    playPlaylistContext(playlistUri);
                });
                console.log("Play Playlist button event listener attached.");
            } else {
                console.warn("playPlaylistButton not found. Play playlist functionality may be limited.");
            }

            if (playPauseButton) {
                playPauseButton.addEventListener('click', togglePlayPause);
            } else {
                console.warn("playPauseButton not found. Playback controls may be limited.");
            }
            if (skipNextButton) {
                skipNextButton.addEventListener('click', skipToNextTrack);
            } else {
                console.warn("skipNextButton not found. Playback controls may be limited.");
            }
            if (skipPreviousButton) {
                skipPreviousButton.addEventListener('click', skipToPreviousTrack);
            } else {
                console.warn("skipPreviousButton not found. Playback controls may be limited.");
            }
            if (shuffleButton) {
                shuffleButton.addEventListener('click', toggleShuffle);
            } else {
                console.warn("shuffleButton not found. Playback controls may be limited.");
            }
            if(hideInfoButton)
            {
                hideInfoButton.addEventListener('click', (ev) => { showHideInfo(); });
            }
            else
            {
                console.warn("hideInfoButton not found. Playback controls may be limited");
            }


            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('error')) {
                console.log("URL has code or error. Calling handleSpotifyCallback.");
                handleSpotifyCallback();
            } else {
                accessToken = localStorage.getItem('spotify_access_token');
                const expiresAt = localStorage.getItem('spotify_expires_at');

                if (accessToken && expiresAt && Date.now() < parseInt(expiresAt)) {
                    console.log("Access token found in local storage and is still valid.");
                    showMessage('Welcome back! You are already logged in.', false);
                    currentPage = 'app';
                    renderPage();
                    const remainingTime = parseInt(expiresAt) - Date.now();
                    setupTokenExpiration(remainingTime); // Re-establish the timeout
                    startPlaybackPolling();
                    getPlaylists();
                } else {
                    console.log("No valid access token found. Showing auth page.");
                    clearAccessToken(); // Ensure any stale/expired token is cleared
                    currentPage = 'auth';
                    renderPage();
                }
            }
            console.log("DOMContentLoaded logic completed.");
        });
    </script>
</body>
</html>
